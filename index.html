<!DOCTYPE html>
<html>

<head>
  <meta charset="utf-8">
  <title>Heatmaps</title>
  <style>
    #map {
      height: 100%;
    }

    html,
    body {
      height: 100%;
      margin: 0;
      padding: 0;
    }
  </style>
</head>

<body>
  <div id="map"></div>
  <script>
    let map;

    function initMap() {
      map = new google.maps.Map(document.getElementById('map'), {
        zoom: 13,
        center: { lat: 12.95, lng: 77.7 },
      });

      getPoints().then(points => {
        // console.log(points.length);
        // console.log(points)
        const factor = .5;
        const maxHeat = points.reduce((acc, p) => {
          return Math.max(acc, p.heat);
        }, 0)

        points.map(point => {
          const circle = new google.maps.Circle({
            strokeColor: '#000000',
            strokeOpacity: 0.8,
            strokeWeight: 0,
            fillColor: '#ff0000',
            fillOpacity: point.heat / maxHeat * factor,
            map: map,
            center: { lat: point.lat, lng: point.lng },
            radius: 1000,
          });
          circle.addListener('click', function () {
            // console.log(point.details.length)
            if (!point.markers) {
              point.markers = [];
              point.details.map(establishment => {
                // console.log(establishment.name,
                //   establishment.types);
                const marker = new google.maps.Marker({
                  position: {
                    lat: establishment.geometry.location.lat,
                    lng: establishment.geometry.location.lng
                  },
                  map: map,
                  title: establishment.name,
                });
                marker.addListener('click', function () {
                  marker.infoWindow = new google.maps.InfoWindow({
                    content: establishment.name,
                  });
                  marker.infoWindow.open(map, marker);
                });
                point.markers.push(marker);
              });
            } else {
              point.markers.map(marker => {
                marker.setMap(null);
              })
              delete point.markers;
            }
          });
        });
      })
    }

    function getPoints() {
      return fetch('http://localhost:5000/cached', {
        method: 'post',
        body: JSON.stringify({
          lat: 12.9279,
          lng: 77.6271,
          preferences: [
            { name: 'school', weight: 1 },
            { name: 'atm', weight: 2 }
          ]
        })
      })
        .then(res => res.json())
        .then(json => json.heatmaps)
        .then(points => {
          return points.map(point => ({
            ...point,
            lat: parseFloat(point.lat),
            lng: parseFloat(point.lng),
          }))
            .filter(point => point.heat !== 0);
        });
    }
  </script>
  <script async defer src="https://maps.googleapis.com/maps/api/js?key=AIzaSyCHf7bfggJPlwwz98LjvpayBSKYaqulTe4&libraries=visualization&callback=initMap">
  </script>
</body>

</html>